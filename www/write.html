<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="components/loader.js"></script>
    <script src="js/ncmb-2.1.1.min.js"></script>
    <script>
        
        $(function() {
            //mBaaSの初期化
            var application_key = "a3b7c0fcc3dff30daf478b33a89fa1e5526f6f2532e8a06b354468810607b26a";
            var client_key = "2fd76cb50035f957e69b1a1a5ccbc23909d35cbed854c5e3de68e35885a15cfd";
            var ncmb = new NCMB(application_key, client_key); 
            var user = ncmb.User.getCurrentUser();
            
            // ログインチェック
            if (user === null) {
                location.href = "./index.html";
            } else {
                $("#youkoso").append("ようこそ " + user.userName + " さん！<br>" + "[ログアウトはこちら]");
            }
            
            // ログアウト
            $("#youkoso").on("click", function() {
                ncmb.User.logout()
                .then(function() {
                    location.href = "./index.html";
                })
            });
                //送信ボタン
                $('#sousin').on('click', function() {
                    var Contents = ncmb.DataStore("Contents");
                    var contents = new Contents();
                    var cts= $("#content").val();
                    //var cts= document.form.content.value;
                    
                    contents.set("contents", cts)
                             .save()
                             .then(function(){
                                $("#msg").append("内容を送信しました！<br>");
                             })
                             .catch(function(err){
                              $("#msg").html("<p>error:" + error.message + "</p>");
                             })
                    return false;
                });
                //受信ボタン
                $('#jusin').on('click', function() {
                     var Contents = ncmb.DataStore("Contents");
                    
                    Contents.limit(100)
                            .fetchAll()
                            .then(function(contents){
                              $("#post").append(
                                    "<li>" + contents[ Math.floor( Math.random() * contents.length ) ].get("contents") + "</li><br>"
                                    );
                             })
                return false;
                });
                
                $('#clear').on('click', function() {
                     $('#post').empty();
        });
        });
           
    </script>
</head>
<body>
    <div id ="youkoso"></div>
    <form>
        <div>
        <textarea id="content" rows="5" cols="25"></textarea>
        <input id="sousin" type="submit" value="送信！" >
        <input id="jusin" type="submit" value="受信！">
        <input id="clear" type="submit" value="クリア">
        </div>
        <li class="setumei">送信…内容を送信します</li>
        <li class="setumei">受信…投稿された内容を受信します</li>
        <li class="setumei">クリア…受信した投稿内容を削除します</li>
    </form>
    <p id="msg"></p>
    <h3>◇受信した投稿はこちら！</h3>
    <ol id="post"></ol>
</body>
</html>
